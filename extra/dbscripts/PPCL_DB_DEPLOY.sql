SET DEFINE OFF;
SET SERVEROUTPUT ON;

PROMPT ===============================================
PROMPT Starting PPCL Replacement Module DB Deployment
PROMPT ===============================================

------------------------------------------------------
-- TABLES
------------------------------------------------------

CREATE TABLE REPLACEMENT_PRINTER_DETAILS (
	ID NUMBER GENERATED BY DEFAULT AS IDENTITY MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 1 NOCACHE ORDER NOCYCLE NOT NULL ENABLE PRIMARY KEY,
    REPLACEMENT_REQUEST_ID NUMBER NOT NULL,
    AGR_PROD_ID NUMBER NOT NULL,
    EXISTING_P_MODEL_ID NUMBER NOT NULL,
    CLIENT_DOT_ID NUMBER NOT NULL,
    CONTACT_PERSON_NAME VARCHAR2(100),
    CONTACT_PERSON_NUMBER VARCHAR2(30),
    CONTACT_PERSON_EMAIL VARCHAR2(100),
    EXISTING_SERIAL VARCHAR2(50) NOT NULL,
    NEW_P_MODEL_SELECTED_ID NUMBER,
    NEW_P_MODEL_SELECTED_TEXT VARCHAR2(200),
    NEW_P_MODEL_SOURCE VARCHAR2(20) DEFAULT 'MANUAL',
    RECOMMENDED_COMMENTS VARCHAR2(200),
    CREATION_DATE_TIME TIMESTAMP DEFAULT SYSTIMESTAMP,
    UPDATE_DATE_TIME TIMESTAMP DEFAULT SYSTIMESTAMP,
    PRINTER_TYPE VARCHAR2(20),
    PAGE_COUNT NUMBER,
    PAGE_COUNT_COMMENT VARCHAR2(200),
    PRINTER_STAGE_ID NUMBER,
    CONTINUE_EXISTING_COMMERCIAL CHAR(1) DEFAULT 'N',
    AM_COMMERCIAL_COMMENTS VARCHAR2(500),
    PRINTER_ORDER_ITEM_ID NUMBER,
    CHECK (NEW_P_MODEL_SOURCE IN ('MANUAL','AUTO'))
);

CREATE TABLE REPLACEMENT_PULLBACK (
    ID NUMBER GENERATED BY DEFAULT AS IDENTITY MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 1 NOCACHE ORDER NOCYCLE NOT NULL ENABLE PRIMARY KEY,
    REPLACEMENT_REQ_ID NUMBER,
    CALL_ID NUMBER,
    CLIENT_DOT_ID NUMBER,
    LOCATION VARCHAR2(100),
    P_MODEL NUMBER,
    P_SERIAL_NO VARCHAR2(100),
    PICKED_BY VARCHAR2(20) DEFAULT 'ENGINEER',
    STATUS NUMBER,
    COURIER_ID NUMBER,
    COURIER_NAME VARCHAR2(50),
    CONSIGNMENT_NO VARCHAR2(100),
    DISPATCH_DATE DATE,
    ARRIVAL_DATE DATE,
    RECEIPT VARCHAR2(100),
    DESTINATION_BRANCH VARCHAR2(50),
    TRANSPORT_MODE VARCHAR2(30) DEFAULT 'BUS',
    CONTACT_PERSON VARCHAR2(50),
    CONTACT_NUMBER VARCHAR2(10),
    COMMENTS VARCHAR2(2000),
    PRINTER NUMBER DEFAULT 0,
    POWER_CABLE NUMBER DEFAULT 0,
    LAN_CABLE NUMBER DEFAULT 0,
    TRAY NUMBER DEFAULT 0,
    EMPTY_CARTRIDGE NUMBER,
    UNUSED_CARTRIDGE NUMBER,
    PULLBACK_MODE VARCHAR2(50),
    REPLACEMENT_PRINTER_DETAILS_ID NUMBER,
    CHECK (PICKED_BY IN ('ENGINEER','VENDOR')),
    CHECK (TRANSPORT_MODE IN ('BUS','TRAIN','TRANSPORT')),
    CHECK (PRINTER IN (0,1)),
    CHECK (POWER_CABLE IN (0,1)),
    CHECK (LAN_CABLE IN (0,1)),
    CHECK (TRAY IN (0,1))
);

CREATE TABLE "REPLACEMENT_REASON"
(
    "ID"                 NUMBER GENERATED ALWAYS AS IDENTITY MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 1 NOCACHE ORDER  NOCYCLE NOT NULL ENABLE,
    "NAME"               VARCHAR2(200) NOT NULL ENABLE,
    "STATUS"             NUMBER       DEFAULT 1,
    "CREATION_DATE_TIME" TIMESTAMP(6) DEFAULT SYSTIMESTAMP,
    "UPDATE_DATE_TIME"   TIMESTAMP(6) DEFAULT SYSTIMESTAMP,
    CHECK (STATUS IN (0, 1)) ENABLE,
    PRIMARY KEY ("ID")
        USING INDEX ENABLE
);
INSERT INTO REPLACEMENT_REASON
    (NAME, STATUS, CREATION_DATE_TIME, UPDATE_DATE_TIME)
VALUES
    ('Upgrade Request', 1,
     TIMESTAMP '2026-01-27 08:51:23.667783',
     TIMESTAMP '2026-01-27 08:51:23.667783');

INSERT INTO REPLACEMENT_REASON
    (NAME, STATUS, CREATION_DATE_TIME, UPDATE_DATE_TIME)
VALUES
    ('Downgrade Request', 1,
     TIMESTAMP '2026-01-27 08:51:23.678487',
     TIMESTAMP '2026-01-27 08:51:23.678487');

INSERT INTO REPLACEMENT_REASON
    (NAME, STATUS, CREATION_DATE_TIME, UPDATE_DATE_TIME)
VALUES
    ('Service Issue - Beyond Repair', 1,
     TIMESTAMP '2026-01-27 08:51:23.689912',
     TIMESTAMP '2026-01-27 08:51:23.689912');

INSERT INTO REPLACEMENT_REASON
    (NAME, STATUS, CREATION_DATE_TIME, UPDATE_DATE_TIME)
VALUES
    ('Outdated Model', 1,
     TIMESTAMP '2026-01-27 08:51:23.698410',
     TIMESTAMP '2026-01-27 08:51:23.698410');

INSERT INTO REPLACEMENT_REASON
    (NAME, STATUS, CREATION_DATE_TIME, UPDATE_DATE_TIME)
VALUES
    ('Business Requirement Change', 1,
     TIMESTAMP '2026-01-27 08:51:23.710111',
     TIMESTAMP '2026-01-27 08:51:23.710111');

INSERT INTO REPLACEMENT_REASON
    (NAME, STATUS, CREATION_DATE_TIME, UPDATE_DATE_TIME)
VALUES
    ('Performance Issue', 1,
     TIMESTAMP '2026-01-27 08:51:23.719414',
     TIMESTAMP '2026-01-27 08:51:23.719414');

INSERT INTO REPLACEMENT_REASON
    (NAME, STATUS, CREATION_DATE_TIME, UPDATE_DATE_TIME)
VALUES
    ('Client Request', 1,
     TIMESTAMP '2026-01-27 08:51:23.729452',
     TIMESTAMP '2026-01-27 08:51:23.729452');

 COMMIT;

CREATE TABLE REPLACEMENT_REQUEST (
    ID NUMBER GENERATED BY DEFAULT AS IDENTITY MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 1 NOCACHE ORDER NOCYCLE NOT NULL ENABLE PRIMARY KEY,
    REPLACEMENT_REASON_ID NUMBER NOT NULL,
    CLIENT_DOT_ID_SIGNING NUMBER NOT NULL,
    REPLACEMENT_TYPE VARCHAR2(30) NOT NULL,
    REQUESTER_USER_ID NUMBER NOT NULL,
    SERVICE_CALL_ID NUMBER,
    CONTACT_PERSON_NAME VARCHAR2(100),
    CONTACT_PERSON_NUMBER VARCHAR2(30),
    CONTACT_PERSON_EMAIL VARCHAR2(100),
    IS_EDITABLE NUMBER DEFAULT 1 CHECK (IS_EDITABLE IN (0,1)),
    CURRENT_STAGE NUMBER NOT NULL,
    CURRENT_OWNER_ID NUMBER NOT NULL,
    SOURCE VARCHAR2(20) NOT NULL CHECK (SOURCE IN ('SERVICE_CALL','DIRECT')),
    STATUS VARCHAR2(20) NOT NULL,
    CREATION_DATE_TIME TIMESTAMP DEFAULT SYSTIMESTAMP,
    UPDATE_DATE_TIME TIMESTAMP DEFAULT SYSTIMESTAMP,
    SIGNED_LETTER_PATH VARCHAR2(500),
    SIGNED_UPLOAD_DATE TIMESTAMP,
    PRINTER_ORDER_ID NUMBER,
    REPLACEMENT_LETTER_GENERATED NUMBER(1) DEFAULT 0,
    CHECK (REPLACEMENT_TYPE IN ('DURING_CONTRACT','AFTER_CONTRACT')),
    CHECK (STATUS IN ('OPEN','PENDING','REJECTED','COMPLETED','CANCELLED','CLOSED'))
);

CREATE TABLE CREDIT_NOTE (
    ID NUMBER GENERATED BY DEFAULT AS IDENTITY MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 1 NOCACHE ORDER NOCYCLE NOT NULL ENABLE PRIMARY KEY,
    REPLACEMENT_REQUEST_ID NUMBER NOT NULL,
    REPLACEMENT_PRINTER_DTL_ID NUMBER NOT NULL,
    CREDIT_NOTE_NUMBER VARCHAR2(50),
    LOCATION VARCHAR2(200),
    MODEL_NAME VARCHAR2(200),
    SERIAL_NO VARCHAR2(50),
    ISSUE_DESCRIPTION VARCHAR2(500),
    AGREEMENT_RATE NUMBER(12,2),
    CREDIT_AMOUNT NUMBER(12,2),
    COMMENTS VARCHAR2(1000),
    STATUS VARCHAR2(20) DEFAULT 'PENDING'
        CHECK (STATUS IN ('PENDING','APPROVED','REJECTED','COMPLETED','CLOSED')),
    DOCUMENT_PATH VARCHAR2(500),
    CREATED_BY NUMBER NOT NULL,
    CREATION_DATE_TIME TIMESTAMP DEFAULT SYSTIMESTAMP,
    UPDATE_DATE_TIME TIMESTAMP DEFAULT SYSTIMESTAMP
);

CREATE TABLE RPLCE_FLOW_EVENT_TRACKING (
    ID NUMBER GENERATED BY DEFAULT AS IDENTITY MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 1 NOCACHE ORDER NOCYCLE NOT NULL ENABLE PRIMARY KEY,
    REPLACEMENT_REQUEST_ID NUMBER NOT NULL,
    CURRENT_STAGE_ID NUMBER,
    CURRENT_OWNER_USER_ID NUMBER NOT NULL,
    START_AT TIMESTAMP DEFAULT SYSTIMESTAMP,
    END_AT TIMESTAMP,
    COMMENTS VARCHAR2(3000),
    TAT_PERCENTAGE NUMBER(5,2)
);

CREATE TABLE TAT_MASTER (
    ID NUMBER GENERATED BY DEFAULT AS IDENTITY MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 1 NOCACHE ORDER NOCYCLE NOT NULL ENABLE PRIMARY KEY,
    STAGE_CODE VARCHAR2(50) UNIQUE NOT NULL,
    DESCRIPTION VARCHAR2(200) NOT NULL,
    OWNER_ROLE NUMBER,
    TAT_DURATION NUMBER NOT NULL,
    TAT_DURATION_UNIT VARCHAR2(20) DEFAULT 'DAYS'
        CHECK (TAT_DURATION_UNIT IN ('DAYS','HOURS')),
    STATUS NUMBER DEFAULT 1 CHECK (STATUS IN (0,1)),
    CREATION_DATE_TIME TIMESTAMP DEFAULT SYSTIMESTAMP,
    UPDATE_DATE_TIME TIMESTAMP DEFAULT SYSTIMESTAMP
);

------------------------------------------------------
-- SAFE ALTER TABLES
------------------------------------------------------
BEGIN
  EXECUTE IMMEDIATE 'ALTER TABLE PRINTER_ORDER_ITEM ADD PRINTER_PRICE NUMBER';
EXCEPTION WHEN OTHERS THEN IF SQLCODE != -942 THEN RAISE; END IF;
END;
/

BEGIN
  EXECUTE IMMEDIATE 'ALTER TABLE PRINTER_ORDER_ITEM ADD CART_PICKUP_REQ NUMBER';
EXCEPTION WHEN OTHERS THEN IF SQLCODE != -942 THEN RAISE; END IF;
END;
/

BEGIN
  EXECUTE IMMEDIATE 'ALTER TABLE PRINTER_ORDER_ITEM ADD CART_SEND_REQ NUMBER';
EXCEPTION WHEN OTHERS THEN IF SQLCODE != -942 THEN RAISE; END IF;
END;
/

BEGIN
  EXECUTE IMMEDIATE 'ALTER TABLE PRINTER_ORDER_ITEM ADD CART_SENT_QUANITY NUMBER';
EXCEPTION WHEN OTHERS THEN IF SQLCODE != -942 THEN RAISE; END IF;
END;
/

------------------------------------------------------
-- MASTER DATA (IDENTITY SAFE)
------------------------------------------------------

INSERT INTO TAT_MASTER (STAGE_CODE, DESCRIPTION, OWNER_ROLE, TAT_DURATION, TAT_DURATION_UNIT, STATUS) VALUES ('STG1_REQUEST_RAISED','Request Raised',2,3,'DAYS',1);
INSERT INTO TAT_MASTER (STAGE_CODE, DESCRIPTION, OWNER_ROLE, TAT_DURATION, TAT_DURATION_UNIT, STATUS) VALUES ('STG2_SERVICE_TL_REVIEW','Service TL Review',62,3,'DAYS',1);
INSERT INTO TAT_MASTER (STAGE_CODE, DESCRIPTION, OWNER_ROLE, TAT_DURATION, TAT_DURATION_UNIT, STATUS) VALUES ('STG3_AM_MANAGER_REVIEW','AM Manager Review',2,2,'DAYS',1);
INSERT INTO TAT_MASTER (STAGE_CODE, DESCRIPTION, OWNER_ROLE, TAT_DURATION, TAT_DURATION_UNIT, STATUS) VALUES ('STG4_AM_COMMERCIAL','Quotation Pending',2,3,'DAYS',1);
INSERT INTO TAT_MASTER (STAGE_CODE, DESCRIPTION, OWNER_ROLE, TAT_DURATION, TAT_DURATION_UNIT, STATUS) VALUES ('STG5_AM_MANAGER_FINAL','Quotation Sent',2,2,'DAYS',1);
INSERT INTO TAT_MASTER (STAGE_CODE, DESCRIPTION, OWNER_ROLE, TAT_DURATION, TAT_DURATION_UNIT, STATUS) VALUES ('STG6_PRINTER_ORDER','Book Printer Order',2,5,'DAYS',1);
INSERT INTO TAT_MASTER (STAGE_CODE, DESCRIPTION, OWNER_ROLE, TAT_DURATION, TAT_DURATION_UNIT, STATUS) VALUES ('STG7_DISPATCH_LETTER','Dispatch Letter',2,1,'DAYS',1);
INSERT INTO TAT_MASTER (STAGE_CODE, DESCRIPTION, OWNER_ROLE, TAT_DURATION, TAT_DURATION_UNIT, STATUS) VALUES ('STG8_INSTALLATION','Installation',201,7,'DAYS',1);
INSERT INTO TAT_MASTER (STAGE_CODE, DESCRIPTION, OWNER_ROLE, TAT_DURATION, TAT_DURATION_UNIT, STATUS)  VALUES ('STG9_PULLBACK','Pullback',101,5,'DAYS',1);
INSERT INTO TAT_MASTER (STAGE_CODE, DESCRIPTION, OWNER_ROLE, TAT_DURATION, TAT_DURATION_UNIT, STATUS) VALUES ('STG10_QC','QC',201,2,'DAYS',1);
INSERT INTO TAT_MASTER (STAGE_CODE, DESCRIPTION, OWNER_ROLE, TAT_DURATION, TAT_DURATION_UNIT, STATUS) VALUES ('STG11_CREDIT_NOTE','Issue Credit Note',2,3,'DAYS',1);
INSERT INTO TAT_MASTER (STAGE_CODE, DESCRIPTION, OWNER_ROLE, TAT_DURATION, TAT_DURATION_UNIT, STATUS) VALUES ('STG11_CREDIT_NOTE_BILLING','Credit Note Billing',202,3,'DAYS',1);
INSERT INTO TAT_MASTER (STAGE_CODE, DESCRIPTION, OWNER_ROLE, TAT_DURATION, TAT_DURATION_UNIT, STATUS) VALUES ('STG12_CLOSURE','Closed',87,0,'DAYS',1);

PROMPT ===============================================
PROMPT PPCL Replacement Module DB Deployment Completed
PROMPT ===============================================
